<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>构造”回调”的另一种方法 | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    <link rel="next" href="./p18.html" />
    
    
    <link rel="prev" href="./p16.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="gitbook/style.css">


        
    <div class="book" data-level="17" data-basepath="." data-revision="1421843376480">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="p01.html">
            
                
                    <a href="./p01.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Twisted 理论基础
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="p02.html">
            
                
                    <a href="./p02.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         异步编程模式与Reactor初探
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="p03.html">
            
                
                    <a href="./p03.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         初识Twisted
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="p04.html">
            
                
                    <a href="./p04.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         由twisted支持的客户端
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="p05.html">
            
                
                    <a href="./p05.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         由Twisted扶持的客户端
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="p06.html">
            
                
                    <a href="./p06.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         更加“抽象”的运用Twisted
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="p07.html">
            
                
                    <a href="./p07.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         小插曲，Deferred
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="p08.html">
            
                
                    <a href="./p08.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         使用Deferred的诗歌下载客户端
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="p09.html">
            
                
                    <a href="./p09.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         第二个小插曲，deferred
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="p10.html">
            
                
                    <a href="./p10.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         增强defer功能的客户端
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="p11.html">
            
                
                    <a href="./p11.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         改进诗歌下载服务器
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="p12.html">
            
                
                    <a href="./p12.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         改进诗歌下载服务器
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="p13.html">
            
                
                    <a href="./p13.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         使用Deferred新功能实现新客户端
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="p14.html">
            
                
                    <a href="./p14.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         Deferred用于同步环境
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="p15.html">
            
                
                    <a href="./p15.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         测试诗歌
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="p16.html">
            
                
                    <a href="./p16.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         Twisted 进程守护
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="17" data-path="p17.html">
            
                
                    <a href="./p17.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         构造”回调”的另一种方法
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="18" data-path="p18.html">
            
                
                    <a href="./p18.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                         Deferreds 全貌
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="19" data-path="p19.html">
            
                
                    <a href="./p19.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                         取消之前的意图
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="20" data-path="p20.html">
            
                
                    <a href="./p20.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                         轮子内的轮子: Twisted和Erlang
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="21" data-path="p21.html">
            
                
                    <a href="./p21.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                         惰性不是迟缓: Twisted和Haskell
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="22" data-path="p22.html">
            
                
                    <a href="./p22.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                         结束
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_18">
                    
                        <p>=====================================</p>
<h1 id="-">第十七部分 构造&quot;回调&quot;的另一种方法</h1>
<p>你可以从&quot;:doc:<code>p01</code>&quot;开始阅读；也可以浏览&quot;:doc:<code>index</code>&quot;的索引</p>
<h1 id="">简介</h1>
<p>这部分我们将回到&quot;回调&quot;这个主题.我们将介绍另外一种写回调函数的方法,即在Twisted中使用 <code>generators &lt;http://docs.python.org/tutorial/classes.html#generators&gt;</code>_. 我们将演示如何使用这种方法并且与使用&quot;纯&quot; <code>Deferreds</code> 进行对比. 最后, 我们将使用这种技术重写诗歌客户端. 但首先我们来回顾一下 <code>generators</code> 的工作原理,以便弄清楚它为何是创建回调的候选方法.</p>
<h2 id="">简要回顾生成器</h2>
<p>你可能知道, 一个Python生成器是一个&quot;可重启的函数&quot;,它是在函数体中用 <code>yield</code> 语句创建的. 这样做可以使这个函数变成一个&quot;生成器函数&quot;,它返回一个&quot;<code>iterator &lt;http://docs.python.org/tutorial/classes.html#iterators&gt;</code>_&quot;可以用来以一系列步骤运行这个函数. 每个迭代循环都会重启这个函数,继续执行到下一个 <code>yield</code> 语句.</p>
<p>生成器(和迭代器)通常被用来代表以惰性方式创建的值序列. 看一下以下文件中的代码 <code>inline-callbacks/gen-1.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-1.py#L1&gt;</code>_:
::</p>
<pre><code>def my_generator():
        print &#39;starting up&#39;
        yield 1
        print &quot;workin&#39;&quot;
        yield 2
        print &quot;still workin&#39;&quot;
        yield 3
        print &#39;done&#39;

for n in my_generator():
        print n
</code></pre><p>这里我们用生成器创建了1,2,3序列. 如果你运行这些代码,会看到在生成器上做迭代时,生成器中的 <code>print</code> 与循环语句中的 <code>print</code> 语句交错出现.</p>
<p>以下自定义迭代器代码使上面的说法更加明显(<code>inline-callbacks/gen-2.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-2.py#L1&gt;</code>_):
::</p>
<pre><code>def my_generator():
        print &#39;starting up&#39;
        yield 1
        print &quot;workin&#39;&quot;
        yield 2
        print &quot;still workin&#39;&quot;
        yield 3
        print &#39;done&#39;

gen = my_generator()

while True:
        try:
    n = gen.next()
        except StopIteration:
            break
         else:
    print n
</code></pre><p>视作一个序列,生成器仅仅是获取连续值的一个对象.但我们也可以以生成器本身的角度看问题:</p>
<ol>
<li>生成器函数在被循环调用之前并没有执行(使用 <code>next</code> 方法).</li>
<li>一旦生成器开始运行,它将一直执行直到返回&quot;循环&quot;(使用 <code>yield</code>)</li>
<li>当循环中运行其他代码时(如 <code>print</code> 语句),生成器则没有运行.</li>
<li>当生成器运行时, 则循环没有运行(等待生成器返回前它被&quot;阻滞&quot;了).</li>
<li>一旦生成器将控制交还到循环,再启动需要等待任意可能时间(其间任意量的代码可能被执行).</li>
</ol>
<p>这与异步系统中的回调工作方式非常类似. 我们可以把 <code>while</code> 循环视作 <code>reactor</code>, 把生成器视作一系列由 <code>yield</code> 语句分隔的回调函数. 有趣的是, 所有的回调分享相同的局部变量名空间, 而且名空间在不同回调中保持一致.</p>
<p>进一步,你可以一次激活多个生成器(参考例子 <code>inline-callbacks/gen-3.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-3.py#L1&gt;</code>_),使得它们的&quot;回调&quot;互相交错,就像在Twisted系统中独立运行的异步程序.</p>
<p>然而,这种方法还是有一些欠缺.回调不仅仅被 <code>reactor</code> 调用, 它还能接受信息.作为 <code>deferred</code> 链的一部分,回调要么接收Python值形式的一个结果,要么接收 <code>Failure</code> 形式的一个错误.</p>
<p>从Python2.5开始,生成器功能被扩展了.当你再次启动生成器时,可以给它发送信息,如 <code>inline-callbacks/gen-4.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-4.py#L1&gt;</code>_ 所示:
::</p>
<pre><code>class Malfunction(Exception):
        pass

def my_generator():
        print &#39;starting up&#39;

    val = yield 1
        print &#39;got:&#39;, val

    val = yield 2
        print &#39;got:&#39;, val

    try:
    yield 3
    except Malfunction:
            print &#39;malfunction!&#39;

    yield 4

    print &#39;done&#39;

gen = my_generator()

print gen.next() # start the generator
print gen.send(10) # send the value 10
print gen.send(20) # send the value 20
print gen.throw(Malfunction()) # raise an exception inside the generator

try:
    gen.next()
except StopIteration:
        pass
</code></pre><p>在Python2.5以后的版本中, <code>yield</code> 语句是一个计算值的表达式.重新启动生成器的代码可以使用 <code>send</code> 方法代替 <code>next</code> 决定它的值(如果使用 <code>next</code> 则值为 <code>None</code>), 而且你还可以在迭代器内部使用 <code>throw</code> 方法抛出任何异常. 是不是很酷?</p>
<h2 id="">内联回调</h2>
<p>根据我们刚刚回顾的可以向生成器发送值或抛出异常的特性,可以设想它是像 <code>deferred</code> 中的一系列回调,即可以接收结果或错误. 每个回调被 <code>yield</code> 分隔,每一个 <code>yield</code> 表达式的值是下一个回调的结果(或者 <code>yield</code> 抛出异常表示错误).图35显示相应概念:</p>
<p>.. _figure35:</p>
<p>.. figure:: _static/p17_generator-callbacks1.png</p>
<p>|   图35:作为回调序列的生成器</p>
<p>现在一系列回调以 <code>deferred</code> 方式被链接在一起,每个回调从它前面的回调接收结果.生成器很容易做到这一点——当再次启动生成器时,仅仅使用 <code>send</code> 发送上一次调用生成器的结果( <code>yield</code> 产生的值).但这看起来有点笨,既然生成器从开始就计算这个值,为什么还需要把它发送回来? 生成器可以将这个值储存在一个变量中供下一次使用. 因此这到底是为什么呢?</p>
<p>回忆一下我们在 :doc:<code>p13</code> 中所学, <code>deferred</code> 中的回调还可以返回 <code>deferred</code> 本身. 在这种情况下, 外层的 <code>deferred</code> 先暂停等待内层的 <code>deferred</code> 激发,接下来外层 <code>deferred</code> 链使用内层 <code>deferred</code> 的返回结果(或错误)激发后续的回调(或错误回调).</p>
<p>所以设想我们的生成器生成一个 <code>deferred</code> 对象而不是一个普通的Python值. 这时生成器会自动&quot;暂停&quot;;生成器总是在每个 <code>yield</code> 语句后暂停直到被显示的重启.因而我们可以延迟它的重启直到 <code>deferred</code> 被激发, 届时我们会使用 <code>send</code> 方法发送值(如果 <code>deferred</code> 成功)或者抛出异常(如果 <code>deferred</code> 失败).这就使我们的生成器成为一个真正的异步回调序列,这正是 <code>twisted.internet.defer &lt;http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py&gt;</code><em> 中 <code>inlineCallbacks &lt;http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#L973&gt;</code></em> 函数背后的概念.</p>
<h1 id="">进一步讨论内联回调</h1>
<p>考虑以下例程, 位于 <code>inline-callbacks/inline-callbacks-1.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/inline-callbacks-1.py#L1&gt;</code>_: 
::</p>
<pre><code>from twisted.internet.defer import inlineCallbacks, Deferred

@inlineCallbacks
def my_callbacks():
        from twisted.internet import reactor

    print &#39;first callback&#39;
        result = yield 1 # yielded values that aren&#39;t deferred come right back

    print &#39;second callback got&#39;, result
        d = Deferred()
        reactor.callLater(5, d.callback, 2)
        result = yield d # yielded deferreds will pause the generator

        print &#39;third callback got&#39;, result # the result of the deferred

    d = Deferred()
        reactor.callLater(5, d.errback, Exception(3))

    try:
    yield d
        except Exception, e:
            result = e

    print &#39;fourth callback got&#39;, repr(result) # the exception from the deferred

    reactor.stop()

from twisted.internet import reactor
reactor.callWhenRunning(my_callbacks)
reactor.run()
</code></pre><p>运行这个例子可以看到生成器运行到最后并终止了 <code>reactor</code>, 这个例子展示了 <code>inlineCallbacks</code> 函数的很多方面.首先, <code>inlineCallbacks</code> 是一个修饰符,它总是修饰生成器函数,如那些使用 <code>yield</code> 语句的函数. <code>inlineCallbacks</code> 的全部目的是将一个生成器按照上述策略转化为一系列异步回调.</p>
<p>第二,当我们调用一个用 <code>inlineCallbacks</code> 修饰的函数时,不需要自己调用 <code>send</code> 或 <code>throw</code> 方法.修饰符会帮助我们处理细节,并确保生成器运行到结束(假设它不抛出异常).</p>
<p>第三,如果我们从生成器生成一个非延迟值,它将以 <code>yield</code> 生成的值立即重启.</p>
<p>最后,如果我们从生成器生成一个 <code>deferred</code>,它不会重启除非此 <code>deferred</code> 被激发.如果 <code>deferred</code> 成功返回,则 <code>yield</code> 的结果就是 <code>deferred</code> 的结果.如果 <code>deferred</code> 失败了,则 <code>yield</code> 会抛出异常. 注这个异常仅仅是一个普通的 <code>Exception</code> 对象,而不是 <code>Failure</code>,我们可以在 <code>yield</code> 外面用 <code>try/except</code> 块捕获它们.</p>
<p>在上面的例子中,我们仅用 <code>callLater</code> 在一小段时间之后去激发 <code>deferred</code>.虽然这是一种将非阻塞延迟放入回调链的实用方法,但通常我们会生成一个 <code>deferred</code>,它是被生成器中其他的异步操作(如 <code>get_poetry</code>)返回的.</p>
<p>OK,现在我们知道了 <code>inlineCallbacks</code> 修饰的函数是如何运行的,但当你实际调用时会返回什么值呢?正如你认为的,将得到 <code>deferred</code>.由于不能确切地知道生成器何时停止(它可能生成一个或多个 <code>deferred</code>),装饰函数本身是异步的,所以 <code>deferred</code> 是一个合适的返回值.注:这个返回的 <code>deferred</code> 不是生成器中 <code>yield</code> 生成的 <code>deferred</code>.相反,它在生成器完全结束(或抛出异常)后才被激发.</p>
<p>如果生成器抛出一个异常,那么返回的 <code>deferred</code> 将激发它的错误回调链,把异常包含在一个 <code>Failure</code> 中. 但是如果我们希望生成器返回一个正常值,必须使用 <code>defer.returnValue</code> 函数. 就像普通 <code>return</code> 语句一样,它也会终止生成器(实际会抛出一个特殊异常).例子 <code>inline-callbacks/inline-callbacks-2.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/inline-callbacks-2.py#L1&gt;</code>_ 说明了这两种可能.</p>
<h2 id="70">客户端7.0</h2>
<p>让我们在新版本的诗歌客户端中加入 <code>inlineCallbacks</code>,你可以在 <code>twisted-client-7/get-poetry.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-7/get-poetry.py#L1&gt;</code><em> 中查看源代码.也许你需要与客户端6.0—— <code>twisted-client-6/get-poetry.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L151&gt;</code></em> 进行对比,它们的相对变化位于 <code>poetry_main &lt;https://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-7/get-poetry.py#L151&gt;</code>_:
::</p>
<pre><code>def poetry_main():
        addresses = parse_args()

    xform_addr = addresses.pop(0)

    proxy = TransformProxy(*xform_addr)

    from twisted.internet import reactor

    results = []

    @defer.inlineCallbacks
        def get_transformed_poem(host, port):
            try:
        poem = yield get_poetry(host, port)
        except Exception, e:
                print &gt;&gt;sys.stderr, &#39;The poem download failed:&#39;, e
                raise

    try:
        poem = yield proxy.xform(&#39;cummingsify&#39;, poem)
        except Exception:
                print &gt;&gt;sys.stderr, &#39;Cummingsify failed!&#39;

    defer.returnValue(poem)

   def got_poem(poem):
           print poem

   def poem_done(_):
           results.append(_)
           if len(results) == len(addresses):
                  reactor.stop()

   for address in addresses:
           host, port = address
           d = get_transformed_poem(host, port)
           d.addCallbacks(got_poem)
           d.addBoth(poem_done)

   reactor.run()
</code></pre><p>在这个新版本里, <code>inlineCallbacks</code> 生成函数 <code>get_transformed_poem</code> 负责取回诗歌并且应用变换(通过变换服务).由于这两个操作都是异步的,我们每次生成一个 <code>deferred</code> 并且隐式地等待结果.与客户端6.0一样,如果变换失败则返回原始诗歌.我们可以使用 <code>try/except</code> 语句捕获生成器中的异步错误. </p>
<p>我们以先前的方式测试新版客户端. 首先启动一个变换服务:
::</p>
<pre><code>python twisted-server-1/tranformedpoetry.py --port 10001
</code></pre><p>然后启动两个诗歌服务器:
::</p>
<pre><code>python twisted-server-1/fastpoetry.py --port 10002 poetry/fascination.txt
python twisted-server-1/fastpoetry.py --port 10003 poetry/science.txt
</code></pre><p>现在可以运行新的客户端:
::</p>
<pre><code>python twisted-client-7/get-poetry.py 10001 10002 10003
</code></pre><p>试试关闭一个或多个服务器,看一看客户端如何捕获错误.</p>
<h2 id="">讨论</h2>
<p>就像 <code>Deferred</code> 对象, <code>inlineCallbacks</code> 函数给我们一种组织异步回调的新方式.同时,如同使用 <code>deferred</code>, <code>inllineCallbacks</code> 没有改变游戏规则.特别地,我们的回调仍然一次调用一个回调,它们仍然被 <code>reactor</code> 调用.我们可以通过打印内联回调的回溯跟踪信息来证实这一点,参见脚本 <code>inline-callbacks/inline-callbacks-tb.py &lt;https://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/inline-callbacks-tb.py#L1&gt;</code>_.运行此代码你将首先获得一个关于 <code>reactor.run()</code> 的回溯,然后是许多帮助函数信息,最后是我们的回调.</p>
<p>图29解释了当 <code>deferred</code> 中一个回调返回另一个 <code>deferred</code> 时会发生什么,我们调整它来展示当一个 <code>inlineCallbacks</code> 生成器生成一个 <code>deferred</code> 时会发生什么,参考图36:</p>
<p>.. _figure36:</p>
<p>.. figure:: _static/p17_inline-callbacks1.png</p>
<p>|    图36: <code>inlineCallbacks</code> 函数中的控制流</p>
<p>同样的图对两种情况都适用,因为它们表示的想法都是一样的 —— 一个异步操作正在等待另一个.</p>
<p>由于 <code>inlineCallbacks</code> 和 <code>deferred</code> 解决许多相同的问题,在它们之间如何选择呢?下面列出一些 <code>inlineCallbacks</code> 的潜在优势.</p>
<ul>
<li>由于回调分享相同的名空间,因此没有必要传递额外状态.</li>
<li>回调的顺序很容易看到,因为它总是从上到下执行.</li>
<li>节省了每个回调函数的声明和隐式控制流,通常减少输入.</li>
<li>可以使用熟悉的 <code>try/except</code> 语句处理错误.</li>
</ul>
<p>当然也存在一些缺陷:</p>
<ul>
<li>生成器中的回调不能被单独调用,这使代码重用比较困难.而构造 <code>deferred</code> 的代码则能够以任意顺序自由地添加任何回调.</li>
<li>生成器的紧致性可能混淆一个事实,其实异步回调非常晦涩.尽管生成器看起来像一个普通的函数序列,但是它的行为却非常不一样. <code>inlineCallbacks</code> 函数不是一种避免学习异步编程模型的方式.</li>
</ul>
<p>就像任何技术,实践将积累出必要的经验,帮你做出明智选择.</p>
<h2 id="">总结</h2>
<p>在这个部分,我们学习了 <code>inlineCallbacks</code> 装饰符以及它怎样使我们能够以Python生成器的形式表达一系列异步回调.</p>
<p>在 :doc:<code>p18</code> 中,我们将学习一种管理 <strong>一组</strong> &quot;并行&quot;异步操作的技术.</p>
<h2 id="">参考练习</h2>
<ol>
<li>为什么 <code>inlineCallbacks</code> 函数是复数(形式)?</li>
<li>研究 <code>inlineCallbacks &lt;http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#973&gt;</code><em> 的实现以及它们帮助函数 <code>_inlineCallbacks &lt;http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#L874&gt;</code></em>. 并思考短语&quot;魔鬼在细节处&quot;.</li>
<li>有N个 <code>yield</code> 语句的生成器中包含多少个回调,假设其中没有循环或者 <code>if</code> 语句?</li>
<li>诗歌客户端7.0可能同时运行三个生成器.概念上,它们之间有多少种不同的交错方式?考虑诗歌客户端和 <code>inlineCallbacks</code> 的实现,你认为实际有多少种可能?</li>
<li>把客户端7.0中的 <code>got_poem</code> 放入到生成器中.</li>
<li>把 <code>poem_done</code> 回调放入生成器.小心!确保处理所有失败情况以便无论怎样 <code>reactor</code> 都会关闭.与使用 <code>deferred</code> 关闭 <code>reactor</code> 对比代码有何不同?</li>
<li>一个在 <code>while</code> 循环中使用 <code>yield</code> 语句的生成器代表一个概念上的无限序列.那么同样的装饰有 <code>inlineCallbacks</code> 的生成器又代表什么呢?</li>
</ol>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./p16.html" class="navigation navigation-prev " aria-label="Previous page: Twisted 进程守护"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./p18.html" class="navigation navigation-next " aria-label="Next page: Deferreds 全貌"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
